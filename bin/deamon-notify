#! /bin/sh
# Deamon-notify
# Copyright (C) 2015 Mirko van der Waal <mvdw at airmail dot cc>
# Distributed under terms of the GNU2 license.
# A simple root-deamon watcher that notifies you upon change.

GET_DEAMONS() {
    # Get the current running root deamons.
    DEAMONS=($(ps -ef | awk '$3 == 1' | \
                        grep root | \
                        cut -d\: -f3- | \
                        sed 's/[0-9][0-9] //g' | \
                        sed 's/ /_/g'))
    echo "${DEAMONS[@]}"
}

GET_DIFFERENCE(){
    a1="$1"
    a2="$2"
    awk -va1="$a1" -va2="$a2" '
    BEGIN{
        m= split(a1, A1," ")
        n= split(a2, t," ")
        for(i=1;i<=n;i++) { A2[t[i]] }
        for (i=1;i<=m;i++){
            if( ! (A1[i] in A2)  ){
                printf A1[i]" "
            }
        }
    }'
}

OLD=$(GET_DEAMONS)
NEW=$(GET_DEAMONS)

while true; do
    if   [[ ${#OLD} -gt ${#NEW} ]]; then 
        DEAMON=$(GET_DIFFERENCE "${OLD[@]}" "${NEW[@]}")
        DEAMON=$(echo $DEAMON | sed 's/[0-9][0-9]://g' | sed 's/_/ /g')
        notify -f 15 -p low -t  "An deamon has stopped" "${DEAMON[@]}"
        OLD=$(GET_DEAMONS)

    elif [[ ${#OLD} -lt ${#NEW} ]]; then 
        DEAMON=$(GET_DIFFERENCE "${NEW[@]}" "${OLD[@]}")
        DEAMON=$(echo $DEAMON | sed 's/[0-9][0-9]://g' | sed 's/_/ /g')
        notify -f 15 -p low -t "An deamon has started" "${DEAMON[@]}"
        OLD=$(GET_DEAMONS)
    fi
    NEW=$(GET_DEAMONS)
    sleep .5
done
